# Distribution Models
NoSQL의 주요 기능은 **대규모 cluster에서 데이터베이스를 실행할 수 있는 기능**이다. 데이터 크기가 증가함에 따라 데이터베이스를 실행하기 위해 더 큰 서버를 구입하거나 확장하는 것은 어렵고 비용이 많이 들기 때문에 매력적인 옵션으로는 **scale out**이 있다. 
## Single Server
* 가장 간단한 분산 옵션: 분산을 전혀 하지 않는 것
* 데이터베이스를 단일 머신에서 실행하여 모든 작업을 처리
* 단일 서버 구성에서 가장 잘 동작하는 그래프 데이터베이스와 같이 단일 서버 분산 모델을 사용하는 것이 더 합리적인 경우가 존재
## Sharding
* **샤딩(Sharding)**: 대규모 데이터베이스 시스템에서 **데이터를 분할하여 여러 서버에 분산 저장**하는 기법
* **샤드(Shard)**: 데이터베이스를 분할한 각각의 독립된 단위, 각 샤드는 독립된 데이터베이스 인스턴스로서 전체 데이터의 일부분을 저장
* **샤딩 키(Sharding Key)**: 데이터를 샤드에 분배할 때 사용되는 기준이 되는 키
### 분할 방식
* **해시 기반 분할(Hash-Based Sharding)**: 샤딩 키에 해시 함수를 적용하여 **해시 값에 따라 데이터를 분할**한다. 이 방식은 데이가 균등하게 분배되는 장점이 있다.
* **범위 기반 분할(Range-Based Sharding)**: **샤딩 키의 값 범위에 따라 데이터를 분할**한다. 이 방식은 특정 범위의 데이터를 빠르게 검색할 수 있는 장점이 있지만, 데이터가 균등하게 분배되지 않을 수 있다.
* **지리적 분할(Geographic Sharding)**: **지리적 위치(=물리적 위치)에 따라 데이터를 분할**한다. 이는 지리적 특성에 맞춘 빠른 데이터 접근을 가능하게 한다.
### 샤딩의 장점
* **확장성(Scalability)**: 데이터가 여러 서버에 분산 저장되므로, 시스템의 부하를 줄이고 필요에 따라 서버를 추가하여 확장할 수 있다.
* **성능 향상(Performance Improvement)**: 각 서버에 저장된 데이터 양이 줄어들어, 쿼리 처리 속도가 향상되고 병목 형상이 줄어든다.
### 샤딩의 단점
* **복잡성 증가(Complexity Increase)**: 샤딩을 구현하고 관리하는 것은 복잡하며, 데이터 일관성과 트랜잭션 처리에 추가적인 고려가 필요하다.
* **균형 문제(Balancing Issues)**: 데이터 분포가 고르지 않으면, 일부 샤드에 부하가 집중될 수 있다. 
## Master-Slave Replication
* 데이터베이스 인스턴스가 'Master'와 'Slave'라는 두 가지 역할로 나뉘어 각각의 역할 수행
* **Master**
    * 모든 데이터 쓰기 작업은 Master에서 수행된다.
    * 데이터의 변경(삽입, 수정, 삭제)은 Master에서 처리되고, 이 변경 사항이 Slave로 전파된다.
    * 단일 지점에서 데이터의 일관성을 유지하기 때문에, 데이터 충돌이 발생하지 않는다. 
* **Slave**
    * Slave는 Master로부터 데이터를 복제받아 보관한다.
    * 모든 데이터 읽기 작업은 Slave에서 수행할 수 있다.
    * 여러 개의 Slave가 존재할 수 있으며, 이를 통해 읽기 작업의 부하를 분산시킬 수 있다.
    * Slave는 정기적으로 Master로부터 변경 사항을 받아와 자신의 데이터를 업데이트 한다.
### Master-Slave Replication 동작 과정
1. **쓰기 작업**
    * 클라이언트가 데이터를 쓰기 위해 Master에 요청을 보낸다.
    * Master는 데이터를 업데이트를 실행한 후, 그 변경사항을 로그에 저장한다.
    * 이 로그를 기반으로 Slave들에게 변경 사항을 전파한다.
2. **읽기 작업**
    * 클라이언트가 데이터를 읽기 위해 Slave에게 요청을 보낸다.
    * Slave는 자신이 보유한 데이터에서 요청된 정보를 반환한다.
    * 여러 Slave에게 읽기 요청을 분산시켜, 읽기 성능을 높일 수 있다.
### Master-Slave Replication의 장점
* **읽기 성능 향상**: 여러 Slave에 걸쳐 읽기 요청을 분산시켜 처리할 수 있기 때문에 읽기 성능이 크게 향상된다.
* **고가용성**: Master가 장애를 일으키면 Slave를 마스터로 승격시키는 방식으로 서비스의 연속성을 유지할 수 있다.
    * **수동 선택**: Cluster를 구성할 때 하나의 노드를 Master로 선정하는 것을 의미한다.
    * **자동 선택**: 노드 cluster를 생성하고, cluster 내에서 스스로 Master를 선정하도록 한다. 자동 선택은 구성 단순화 뿐만 아니라 Master에 장애가 생겼을 때 cluster가 자동으로 새로운 Master를 선택하여 다운타임을 줄이는 이점이 있다. 
* **확장성**: Slave를 추가하여 읽기 성능을 쉽게 확장할 수 있다.
### Master-Slave Replication의 단점 
* **데이터의 일관성 문제**: Slave는 일정 시간 동안 Master와 데이터 일관성이 맞지 않을 수 있다.(최종 일관성)
* **단일 실패 지점**: Master가 단일 실패 지점(Single point of failure)이다. Master에 문제가 발생하면, 데이터 쓰기 작업이 중단될 수 있다. 
* **복잡한 운영 관리**: Master와 Slave 간의 데이터 동기화 및 장애 복구 절차가 복잡할 수 있다. 
## Peer-to-Peer Replication
* 모든 노드가 **동등한 역할**을 수행
* 특정 노드에 의존하지 않고 모든 노드가 읽기와 쓰기 작업을 처리할 수 있는 분산 시스템을 구축하는 데 중점
### Peer-to-Peer Replication의 특징
* **분산된 책임**
    * 모든 노드는 동등한 역할을 수행하며, 특정 노드가 Master 역할을 하지 않는다.
    * 각 노드는 데이터를 읽고 쓸 수 있으며, 데이터 변경 사항을 다른 노드와 동기화한다.
* **높은 가용성**
    * 다른 노드가 계속해서 데이터를 읽고 쓸 수 있기 때문에 특정 노드의 장애가 전체 시스템에 큰 영향을 미치지 않는다.
    * 시스템 전체가 탄력적으로 작동하며, 단일 실패 지점(Single point of failure)이 존재하지 않는다.
* **확장성**
    * 노드를 추가하는 것이 비교적 용이하며, 이를 통해 읽기 및 쓰기 성능을 확장할 수 있다.
    * 데이터와 트래픽이 모든 노드에 고르게 분산된다. 
### Peer-to-Peer Replication 동작 원리
1. **데이터 복제**
    * 데이터를 생성, 수정, 삭제하는 모든 작업이 여러 노드에 복제된다.
    * 변경 사항은 다른 노드들로 전파되어 데이터의 일관성을 유지한다.
2. **데이터 일관성**
    * P2P 시스템에서는 주로 최종 일관성(Eventual consistency)을 보장한다. 즉, 모든 노드가 최종적으로 동일한 데이터를 가지게 되지만, 일시적인 불일치는 존재할 수 있다.
    * 일부 P2P 시스템에서는 강력한 일관성(Strong consistency)을 제공하기 위해 다양한 알고리즘을 사용한다.
3. **충돌 해결**
    * 여러 노드에서 동시에 데이터 변경이 발생할 수 있으므로, 데이터 충돌이 발생할 가능성이 있다.
    * 시스템은 이러한 충돌을 감지하고 해결하기 위한 메커니즘을 제공한다. (ex. Vector Clocks, Conflict-free Replicated Data Types)
### Peer-to-Peer Replication의 장점
* **고가용성**: 단일 노드의 장애가 시스템 전체에 영향을 미치지 않는다.
* **확장성**: 노드를 추가함으로써 시스템의 처리 능력을 쉽게 확장할 수 있다. 
* **균형된 부하 분산**: 데이터와 트래픽이 고르게 분산되어 특정 노드에 부하가 집중되지 않는다.
### Peer-to-Peer Replication의 단점
* **데이터 일관성 문제**: 즉각적인 일관성을 보장하지 않는 경우, 데이터 일관성을 유지하는 데 어려움이 있을 수 있다.
* **복잡한 충돌 해결**: 데이터 충돌이 발생할 경우 이를 해결하는 로직이 필요하다.
* **관리 복잡성**: 모든 노드가 동등한 역할을 하기 때문에, 시스템 관리가 복잡해질 수 있다. 
## Combining Sharding and Replication
### Master-Slave Replication + Sharding
* 여러 Master가 존재하게 되지만 각 데이터 항목에는 단일 Master만 존재
* 구성에 따라 일부 데이터를 위한 Master 역할을 하고 다른 데이터를 위한 Slave 역할을 하는 노드를 선택할 수 있고, 또는 노드를 Master나 Slave 역할만 전담하게 할 수 있다.
### Peer-to-Peer Replication + Shardig
* Column-Family 데이터베이스에서 흔히 사용하는 방식
* 데이터가 샤딩되어 cluster의 수십 또는 수백 개의 노드에 분산
* 노드가 장애를 일으키면 해당 노드에 있던 샤드가 다른 노드에서 다시 구축된다. 
* 가장 효과적인 시작을 위한 복제 계수는 3 
